#!/bin/bash

# Script to deploy the latest release (blue/green aware)

set -euo pipefail

# Helpers ----------------------------------------------------------------------
# Print echo messages in bold --------------------------------------------------
function bold_echo() {
  echo -e "\033[1m$1\033[0m"
}

# Determine active service -----------------------------------------------------
function determine_active_service() {
  ACTIVE_SERVICE_FILE_PATH="/etc/{{ deploy.service_name }}/active_service"
  ACTIVE_SERVICE=

  # If no active service was configured yet (i.e. first deploy) then use "blue"
  if [ ! -f "$ACTIVE_SERVICE_FILE_PATH" ]; then
    echo "green" > "$ACTIVE_SERVICE_FILE_PATH"
  fi

  read -r ACTIVE_SERVICE < "$ACTIVE_SERVICE_FILE_PATH"
}
# HELPERS ----------------------------------------------------------------------


# Set up our variables ---------------------------------------------------------
# Determine which (blue / green) is going to be active after deployment. -------
determine_active_service

NEW_SERVICE=

if [ "$ACTIVE_SERVICE" = "blue" ]; then
  NEW_SERVICE="green"
else
  NEW_SERVICE="blue"
fi

APP_DIR="/srv/app/{{ deploy.service_name }}_${NEW_SERVICE}"


# Deploy new version ----------------------------------------------------------
bold_echo "===> $NEW_SERVICE | Deploying new app version"
if [ ! -d "$APP_DIR" ]; then
  bold_echo "===> Creating $APP_DIR"
  mkdir -p $APP_DIR
  chown -R {{ deploy.service_name }}:{{ deploy.service_name }} $APP_DIR
fi

# copy all new files & make sure no longer existing files are deleted
rsync -a --delete \
      --chown={{ deploy.service_name }}:{{ deploy.service_name }} \
      "$HOME/{{ deploy.service_name }}/" $APP_DIR

# Enable and start new (blue/green) service ------------------------------------
bold_echo "===> $NEW_SERVICE | Enable: {{ deploy.service_name }}_${NEW_SERVICE}.service"
systemctl enable "{{ deploy.service_name }}_${NEW_SERVICE}.service"

bold_echo "===> $NEW_SERVICE | Start: {{ deploy.service_name }}_${NEW_SERVICE}.service"
systemctl start "{{ deploy.service_name }}_${NEW_SERVICE}.service"

bold_echo "===> $NEW_SERVICE | Wait until node is responsive"
export "$(grep '^PORT=' /etc/newsletty/newsletty_${NEW_SERVICE}_env | xargs)"

NEXT_WAIT_TIME=0
until curl "http://127.0.0.1:$PORT" > /dev/null 2>&1 || [ $NEXT_WAIT_TIME -eq 20 ]; do
  printf "."
  sleep $(( NEXT_WAIT_TIME++ ))
done

printf "\n"

# Update NGINX config and reload -----------------------------------------------
bold_echo "===> $NEW_SERVICE | NGINX: Link new service to sites-enabled"
ln -sf "/etc/nginx/sites-available/${NEW_SERVICE}.{{ deploy.nginx_vhost }}" \
       "/etc/nginx/sites-enabled/{{ deploy.nginx_vhost }}"

bold_echo "===> $NEW_SERVICE | NGINX: Test & reload"
nginx -t
systemctl reload nginx

# Stop and disable old (blue/green) service ------------------------------------
bold_echo "===> $ACTIVE_SERVICE | Stop: {{ deploy.service_name }}_${ACTIVE_SERVICE}.service"
systemctl stop "{{ deploy.service_name }}_${ACTIVE_SERVICE}.service"

bold_echo "===> $ACTIVE_SERVICE | Disable: {{ deploy.service_name }}_${ACTIVE_SERVICE}.service"
systemctl disable "{{ deploy.service_name }}_${ACTIVE_SERVICE}.service"

# Mark new (blue/green) service as active --------------------------------------
bold_echo "===> $NEW_SERVICE | Active: Set $NEW_SERVICE as active"
echo "$NEW_SERVICE" > "$ACTIVE_SERVICE_FILE_PATH"

# Cleanup ----------------------------------------------------------------------
bold_echo "===> Cleanup"
rm -rf "$HOME/{{ deploy.service_name }}"

bold_echo "===> Done"

exit 0
